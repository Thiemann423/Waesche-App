<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>W√§schausgabe</title>

  <!-- ‚úÖ MSAL zuerst laden -->
  <script src="https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js"></script>

  <!-- ‚úÖ Jetzt ist msal verf√ºgbar -->
<script>
  const msalConfig = {
    auth: {
      clientId: "eb47dcba-4ea2-4a3a-9af1-20a017d605e9",
      authority: "https://login.microsoftonline.com/f54f53bb-d0ff-4b78-bcf4-4aeeeb924428",
      redirectUri: "https://thiemann423.github.io/Waesche-App/index_fertig_123final.html"
    },
    cache: { cacheLocation: "localStorage", storeAuthStateInCookie: true }
  };

  const scopes = ["Files.ReadWrite.All", "offline_access", "openid", "profile"];
  const msalInstance = new msal.PublicClientApplication(msalConfig);

  // Freigabe-Link (ohne ?e=...)
  const SHARE_URL = "https://petrifeinkost-my.sharepoint.com/:f:/g/personal/merten_thiemann_petri-feinkost_de/Ensf79Quc4JMl3Sd5k1LKSEBKBLm9Z9frRvyT-GIazBAKA";
  const SHARE_KEY = "WAESCHE_SHARE_URL";
  if (localStorage.getItem(SHARE_KEY) !== SHARE_URL) {
    localStorage.removeItem("WAESCHE_DRIVE_ID");
    localStorage.removeItem("WAESCHE_FOLDER_ID");
    localStorage.setItem(SHARE_KEY, SHARE_URL);
  }

  function b64u(s){ return btoa(s).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,''); }

  async function ensureTargetIds() {
    let driveId  = localStorage.getItem("WAESCHE_DRIVE_ID");
    let folderId = localStorage.getItem("WAESCHE_FOLDER_ID");
    if (driveId && folderId) return { driveId, folderId };

    const accessToken = await getAccessToken();
    const token = "u!" + b64u(SHARE_URL);
    const r = await fetch(
      "https://graph.microsoft.com/v1.0/shares/" + encodeURIComponent(token) +
      "/driveItem?$select=id,parentReference",
      { headers: { Authorization: `Bearer ${accessToken}` } }
    );
    if (!r.ok) throw new Error(await r.text());
    const item = await r.json();

    driveId  = item.parentReference.driveId;
    folderId = item.id;

    localStorage.setItem("WAESCHE_DRIVE_ID", driveId);
    localStorage.setItem("WAESCHE_FOLDER_ID", folderId);
    return { driveId, folderId };
  }

  async function getAccessToken() {
    const request = { scopes };
    let account = msalInstance.getActiveAccount() || msalInstance.getAllAccounts()[0];

    if (account) {
      try {
        const t = await msalInstance.acquireTokenSilent({ ...request, account });
        return t.accessToken;
      } catch (e) {
        console.warn("Silent token failed:", e);
      }
    }

    try {
      const login = await msalInstance.loginPopup(request);
      msalInstance.setActiveAccount(login.account);
      const t = await msalInstance.acquireTokenSilent({ ...request, account: login.account });
      return t.accessToken;
    } catch (e) {
      if (e && (e.errorCode === "popup_window_error" || e.errorCode === "popup_window_open_error")) {
        msalInstance.loginRedirect(request); // Fallback wenn Popups blockiert sind
        return;
      }
      throw e;
    }
  }

  // Beim Laden: Redirect-Ergebnis verarbeiten + anmelden
  window.addEventListener("DOMContentLoaded", async () => {
    try {
      const redirectResult = await msalInstance.handleRedirectPromise?.();
      if (redirectResult?.account) {
        msalInstance.setActiveAccount(redirectResult.account);
      }
      await getAccessToken();
      console.log("‚úÖ angemeldet");
    } catch (e) {
      console.error("‚ùå Login fehlgeschlagen", e);
      alert(`‚ùå Anmeldung nicht m√∂glich.\n${e.errorCode || e.name || ""}\n${e.errorMessage || e.message || ""}`);
    }
  });
</script>




  <!-- Dein CSS -->
  <link rel="stylesheet" href="style.css" />
</head>



    

<style>
  body { font-family: sans-serif; padding: 20px; }
  input, select, textarea { display: block; margin-bottom: 10px; padding: 8px; width: 100%; }
  .artikel {
    margin-bottom: 10px;
    border: 1px solid #ccc;
    padding: 10px;
    position: relative;           /* <- NEU: f√ºr den Close-Button */
  }
  canvas { border: 1px solid #000; width: 100%; height: 150px; touch-action: none; }
  button { padding: 10px 20px; margin-top: 10px; }
  .bestand-container, .dashboard-container { margin-top: 40px; padding: 20px; border: 1px solid #333; }
  table { width: 100%; border-collapse: collapse; margin-top: 10px; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
  h2 { margin-top: 40px; }

  /* --- Tabelle Bestand sch√∂ner und kompakter --- */
  #bestandTabelle input[type="text"],
  #bestandTabelle input[type="number"] {
    width: 100%;
    box-sizing: border-box;
  }
  #bestandTabelle td { vertical-align: middle; }
  #bestandTabelle button { display: block; margin: 4px auto; width: 90%; }
  #bestandTabelle td:nth-child(1) {
    width: 200px; max-width: 200px; word-break: break-word;
  }
  #bestandTabelle td:nth-child(2),
  #bestandTabelle td:nth-child(3) { width: 80px; text-align: center; }
  #bestandTabelle td:nth-child(4) { width: 100px; }
  #bestandTabelle input.name-input { font-size: 0.9em; }

  /* ‚úñ Button in der Artikel-Zeile */
  .artikel .removeRow {
    position: absolute;
    right: 8px;
    top: 8px;
    font-size: 12px;
    padding: 2px 8px;
    line-height: 1;
    cursor: pointer;
  }
</style>



<!-- jsPDF-Bibliothek laden -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<!-- Dein neuer Filter- & PDF-Code -->
<script>
  function filterNachStart() {
    const filter = document.getElementById("filterStartdatum").value;
    const gefundene = mitarbeiterListe.filter(m => m.start && m.start.startsWith(filter));

    const ergebnisListe = document.getElementById("startErgebnisse");
    if (gefundene.length === 0) {
      ergebnisListe.innerHTML = "<li>Keine passenden Mitarbeiter gefunden.</li>";
    } else {
      ergebnisListe.innerHTML = gefundene.map(m => `<li>${m.name} (Start: ${m.start})</li>`).join("");
    }

    window._letzteGefilterteMitarbeiter = gefundene;
  }

  function exportiereStartPdf() {
    const gefundene = window._letzteGefilterteMitarbeiter || [];
    if (gefundene.length === 0) {
      alert("Keine gefilterten Mitarbeiter vorhanden.");
      return;
    }

    const doc = new jspdf.jsPDF();
    doc.setFontSize(14);
    doc.text("Mitarbeiter-Start√ºbersicht", 10, 10);

    gefundene.forEach((m, i) => {
      doc.text(`${i + 1}. ${m.name} ‚Äì Start: ${m.start}`, 10, 20 + i * 10);
    });

    doc.save("mitarbeiter_start√ºbersicht.pdf");
  }
</script>



<body>
  <h1>W√§scheauftrag</h1>

  <!-- Datalist global -->
  <datalist id="artikelListeGlobal">
    <!-- Optionen werden sp√§ter per JavaScript bef√ºllt -->
  </datalist>

  <select id="kategorieSelect" onchange="kategorieWechsel()">
    <option value="frauen" selected>Mitarbeiterin</option>
    <option value="maenner">Mitarbeiter</option>
    <option value="zeitarbeiter">Zeitarbeiter</option>
    <option value="produktion">Produktion</option>
  </select>

  <label>Mitarbeiter suchen:</label>
  <input list="mitarbeiterListe" id="mitarbeiterInput">
  <datalist id="mitarbeiterListe"></datalist>

  <label>Spindnummer suchen:</label>
  <input id="idInput" placeholder="z.‚ÄØB. 012 oder 12" oninput="sucheNachID()">

  <label>Abteilung:</label>
  <input id="abteilung">

  <label>Ausgabedatum:</label>
  <input type="date" id="datum">

  <div id="artikelContainer"></div>
  <button onclick="addArtikel()">+ Artikel hinzuf√ºgen</button>

  <label>Bemerkung:</label>
  <textarea id="bemerkung"></textarea>

  <h3>Unterschrift Mitarbeiter</h3>
  <canvas id="sigMitarbeiter"></canvas>
  <button onclick="clearCanvas('sigMitarbeiter')">L√∂schen</button>

  <h3>Unterschrift Ausgabe</h3>
  <canvas id="sigAusgabe"></canvas>
  <button onclick="clearCanvas('sigAusgabe')">L√∂schen</button>

  <button onclick="abschliessen()">Ausgabe abschlie√üen & PDF speichern</button>
  <button onclick="rueckgabeAbschliessen()">R√ºckgabe abschlie√üen & PDF speichern</button>

 <h2>Bestand verwalten</h2>
<button onclick="toggleBestandAnzeige()" id="toggleBestandBtn">Bestand anzeigen</button>

<!-- üîΩ Formular einf√ºgen -->
<h3>Neuen Artikel hinzuf√ºgen</h3>
<div id="artikelFormular">
  <input type="text" id="neuerName" placeholder="Artikelname">
  <input type="text" id="neueGroesse" placeholder="Gr√∂√üe (z. B. M)">
  <input type="text" id="neueNummer" placeholder="Artikelnr. (optional)">
  <input type="number" id="neuerBestand" placeholder="Bestand">
  <button onclick="addNeuerArtikel()">‚ûï Hinzuf√ºgen</button>
</div>


<div class="bestand-container">
  <h3>Aktueller Bestand</h3>

  <label>Suche:</label>
  <input type="text" id="bestandSuche" placeholder="Artikel oder Gr√∂√üe..." oninput="filterBestandTabelle()">

  <!-- Button nach oben gezogen -->
  <div class="bestand-actions" style="margin:8px 0 0">
    <button id="saveAllBestandBtn" onclick="saveBestand()">Alle √Ñnderungen speichern</button>
  </div>

  <table id="bestandTabelle">
    <thead>
      <tr><th>Artikel</th><th>Gr√∂√üe</th><th>Bestand</th><th>Aktionen</th></tr>
    </thead>
    <tbody></tbody>
  </table>

 
  <div









<h2>Dashboard</h2>
<button onclick="toggleDashboardAnzeige()" id="toggleDashboardBtn">Dashboard anzeigen</button>
<div class="dashboard-container">
  <label>Mitarbeiter suchen:</label>
  <input type="text" id="dashboardSearch" oninput="filterDashboard()" placeholder="Name eingeben...">
  
  <label>Von:</label>
  <input type="date" id="startDate" oninput="filterDashboard()">
  
  <label>Bis:</label>
  <input type="date" id="endDate" oninput="filterDashboard()">
  
  <h3>Alle Ausgaben</h3>
  <table id="dashboardTabelle">
    <thead>
      <tr><th>Datum</th><th>Mitarbeiter</th><th>Artikel</th><th>Gr√∂√üe</th><th>Anzahl</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</div>
<div style="margin: 20px 0; padding: 10px; border: 1px solid #ccc; border-radius: 6px; background-color: #f9f9f9;">

  <h3>Speichern & Laden (OneDrive)</h3>
  <button onclick="saveDataToOneDrive()">In OneDrive speichern</button>
  <button onclick="loadDataFromOneDrive()">Aus OneDrive laden</button>
</div>

<h2>Mitarbeiter verwalten</h2>
<button onclick="toggleMitarbeiterVerwaltung()" id="toggleMitarbeiterBtn">Mitarbeiterverwaltung anzeigen</button>
<div class="mitarbeiter-container" style="display: block;">
 <h3>Neuen Mitarbeiter hinzuf√ºgen</h3>
<label>Name:</label>
<input type="text" id="neuerMitarbeiterName">
<label>Startdatum:</label>
<input type="date" id="neuerStart">


<label>Spindnummer (optional):</label>
<input type="text" id="neuerSpind" placeholder="z. B. 045 (M√§nner) ‚Äì leer lassen, wenn keiner">



<label>Kategorie:</label>
<select id="neueKategorie" onchange="zeigeFreieSpindnummern()">
  <option value="frauen">Frau</option>
  <option value="maenner">Mann</option>
  <option value="zeitarbeiter">Zeitarbeiter</option>
</select>

<h3>Mitarbeiter nach Startdatum filtern</h3>
<label>Start ab (Monat):</label>
<input type="month" id="filterStartdatum">
<button onclick="filterNachStart()">Filtern</button>
<button onclick="exportiereStartPdf()">Als PDF exportieren</button>

<ul id="startErgebnisse" style="margin-top:10px;"></ul>

<button onclick="addMitarbeiter()">Speichern</button>


 <h3>Freie Spindnummern</h3>
<div id="freieSpindnummernContainer" style="display: none; column-count: 5; column-gap: 20px;"></div>
<button id="toggleSpindBtn" onclick="toggleFreieSpindnummern()">Freie Spindnummern anzeigen</button>


<h3>Aktuelle Mitarbeiter</h3>

<label>Suche:</label>
<input type="text" id="mitarbeiterSearch"
       placeholder="Name oder Spindnummer eingeben..."
       oninput="filterMitarbeiterTabelle()">

<label>Kategorie:</label>
<select id="mitarbeiterKategorieFilter" onchange="renderMitarbeiterTabelle()">
  <option value="alle" selected>Alle</option>
  <option value="frauen">Frauen</option>
  <option value="maenner">M√§nner</option>
  <option value="zeitarbeiter">Zeitarbeiter</option>
</select>

<table id="mitarbeiterTabelle">
  <thead>
    <tr>
      <th>Name</th>
      <th>Spind</th>
      <th>Kategorie</th>
      <th>Aktionen</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>





  <script>
const frauenMitarbeiterListe = [
  // Frauen
 
  { nummer: "1", name: "Burak Olha" },
  { nummer: "2", name: "Craciun Virginia" },
  { nummer: "3", name: "Taranto Cecilia-Anne" },
  { nummer: "4", name: "Cozmariu Elisabeta" },
  { nummer: "6", name: "Kleine Andrea" },
  { nummer: "7", name: "Ziske Viktoria" },
  { nummer: "8", name: "Koch Liubov" },
  { nummer: "9", name: "Bober Monika" },
  { nummer: "10", name: "Bantas Maria" },
  { nummer: "11", name: "Kipka Edith" },
  { nummer: "12", name: "Alo Sabah" },
  { nummer: "13", name: "Sparenberg-Ganswindt Meike" },
  { nummer: "14", name: "Martyin Timea" },
  { nummer: "15", name: "Puiu Claudita" },
  { nummer: "16", name: "M√ºller Karolin" },
  { nummer: "17", name: "Hundertmark Birgit" },
  { nummer: "19", name: "Legler Irena" },
  { nummer: "20", name: "Andreica Maria" },
  { nummer: "21", name: "Geiger Elena" },
  { nummer: "22", name: "Korniyenko, Fevroniia" },
  { nummer: "23", name: "Koriakina Valentyna" },
  { nummer: "24", name: "Guzun Diana" },
  { nummer: "25", name: "Chmylenko Olena" },
  { nummer: "26", name: "Fedorenko Mariia" },
  { nummer: "27", name: "Romanciuc, Vera" },
  { nummer: "28", name: "Puti Maria" },
  { nummer: "29", name: "Heidt Ludmilla" },
  { nummer: "30", name: "Lohvynenko Svitlana" },
  { nummer: "31", name: "Canalas Viorica" },
  { nummer: "32", name: "F√∂rster Dunja" },
  { nummer: "33", name: "Nolting Laura" },
  { nummer: "34", name: "Moldovan Ana-Maria" },
  { nummer: "35", name: "Sassu Claudia" },
  { nummer: "36", name: "Phohbun Saiphin" },
  { nummer: "37", name: "Rotariu Mirela" },
  { nummer: "38", name: "Florea Ionica" },
  { nummer: "39", name: "Schoppe Martina" },
  { nummer: "40", name: "Costa Camelia" },
  { nummer: "41", name: "Kemmerich-Pook, Laura" },
  { nummer: "42", name: "Liabina Yanina" },
  { nummer: "43", name: "Zellober Gabriele" },
  { nummer: "44", name: "Moldovan Emanuela" },
  { nummer: "46", name: "Fahr Kerstin" },
  { nummer: "47", name: "Langemann Elena" },
  { nummer: "48", name: "Wei√üe Cornelia" },
  { nummer: "49", name: "Sadauskiene Inga" },
  { nummer: "50", name: "Liabina Oleksandra" },
  { nummer: "51", name: "Bukii Sofia" },
  { nummer: "52", name: "Golebiewska Beata" },
  { nummer: "53", name: "Golebiewska Julita" },
  { nummer: "54", name: "Bukii Lilia" },
  { nummer: "55", name: "Mevers Heike" },
  { nummer: "56", name: "Eremia Ioana" },
  { nummer: "57", name: "Licina Seniha" },
  { nummer: "58", name: "Lytvynenko Viktoriia" },
  { nummer: "59", name: "Eke Violeta" },
  { nummer: "60", name: "Merten Elke" },
  { nummer: "61", name: "Capra Elisabeta" },

  { nummer: "63", name: "Chochlova Alina" },
  { nummer: "64", name: "Lange Kerstin" },
  { nummer: "65", name: "Moldovan Georgiana" },
  { nummer: "66", name: "Steffen Kerstin" },
  { nummer: "67", name: "Udoviene Nina" },
  { nummer: "68", name: "Teslenko Oksana" },
  { nummer: "69", name: "Dimitrova Teodora" },
  { nummer: "70", name: "Schmidt Nelli" },
  { nummer: "71", name: "Andrei Ana-Maria" },
  { nummer: "72", name: "Denysenko Nataliia" },
  { nummer: "73", name: "Ivanova Mariana" },
  { nummer: "74", name: "Krykunova, Halyna" },
  { nummer: "75", name: "Mamontova Svitlana" },
  { nummer: "76", name: "Grieger Agnieszka" },
  { nummer: "77", name: "Pieper Franziska" },
  { nummer: "78", name: "Ladner Ludmilla" },
  { nummer: "79", name: "Fischer-Brandt, Ramona" },
  { nummer: "80", name: "Moldovan Andra" },
  { nummer: "81", name: "B√∂nig Joanna" },
  { nummer: "82", name: "B√ºcker Regina" },
  { nummer: "83", name: "Rakemann Ann-Kathrin" },
  { nummer: "84", name: "Wasowska Emilia" },
  { nummer: "85", name: "Wecke Susanne" },
  { nummer: "86", name: "Adomariciene Judita" },
  { nummer: "87", name: "Lutze Saskia" },
  { nummer: "88", name: "Feraru, Ana-Maria" },
  { nummer: "89", name: "Kharchenko Nataliia" },
  { nummer: "90", name: "Ciubotaru Elena" },
  { nummer: "91", name: "Babelek Malgorzata" },
  { nummer: "92", name: "Manea Maria" },
  { nummer: "93", name: "Reichenbach Katharina" },
  { nummer: "94", name: "Enache Mihaela" },
  { nummer: "95", name: "Busse Samantha" },
  { nummer: "96", name: "Miksyte Ausra" },
  { nummer: "97", name: "Zbierski Natalja" },
  { nummer: "98", name: "Korthaneberg Miriam" },
  { nummer: "99", name: "Iacob Ariana" },
  { nummer: "100", name: "Melikidze Anjela" },
  { nummer: "103", name: "Sfiea Ana-Maria" },
  { nummer: "104", name: "Caracas Camilia" },
  { nummer: "108", name: "Biere Andrea" },
  { nummer: "111", name: "Ilinescu, Izabela" },
  { nummer: "857", name: "Koch Liubov" },
  { nummer: "850", name: "Pieper Franziska" }
];

 const maennerMitarbeiterListe = [
  { nummer: "01", name: "Ayzenberh Oleksandr" },
  { nummer: "02", name: "Witowski Alexander" },
  { nummer: "03", name: "Frasincar Gabriel" },
  { nummer: "04", name: "Pohl Edgar" },
  { nummer: "05", name: "Hartmann Dirk" },
  { nummer: "06", name: "Jacobi Daniel" },
  { nummer: "08", name: "Kaiser-Koch, Michael" },
  { nummer: "09", name: "Dolbin Andrii" },
  { nummer: "010", name: "Belgacem, Jaber" },
  { nummer: "011", name: "Klatt Severin" },
  { nummer: "012", name: "F√∂rster Christian" },
  { nummer: "013", name: "Ganswindt, Stephan" },
  { nummer: "014", name: "Nikolaev Eugen" },
  { nummer: "015", name: "Silakov Kostiatyn" },
  { nummer: "016", name: "Zurm√ºhlen Hans" },
  { nummer: "017", name: "Guhl Arne" },
  { nummer: "018", name: "Bero Hussain" },
  { nummer: "020", name: "Grieger Thomas" },
  { nummer: "021", name: "Kharchenko Serhii" },
  { nummer: "022", name: "Trujillo Carmelo" },
  { nummer: "023", name: "Moniac  Daniel" },
  { nummer: "024", name: "Pape, Florian Heinrich" },
  { nummer: "025", name: "Heinze Martin" },
  { nummer: "026", name: "Al Mahdawi Luay" },
  { nummer: "027", name: "Karasov Oleksij" },
  { nummer: "028", name: "Strelnikov Evgenij" },
  { nummer: "029", name: "Leshchenko Denys" },
  { nummer: "030", name: "Eitmonas Viktoras" },
  { nummer: "031", name: "Cannizzaro Andreas" },
  { nummer: "033", name: "Hoca Anton" },
  { nummer: "034", name: "Leongardt Vladimir" },
  { nummer: "035", name: "Yogeswaran" },
  { nummer: "036", name: "Vass Iosif" },
  { nummer: "037", name: "Bontea Radu" },
  { nummer: "038", name: "Guzun Alexei" },
  { nummer: "040", name: "Kreikenbohm Patrick" },
  { nummer: "041", name: "Dybek Wieslaw" },
  { nummer: "042", name: "Weimann Nick" },
  { nummer: "043", name: "Martin Alexandru" },
  { nummer: "044", name: "Ritter Alexander (1)" },
  { nummer: "045", name: "Tiemann Frank" },
  { nummer: "046", name: "Murgulet Ruben" },
  { nummer: "047", name: "K√∂ke Jonas" },
  { nummer: "048", name: "Meier Nils" },
  { nummer: "049", name: "Tiemann Frank (blau)" },
  { nummer: "050", name: "Neufeld Alexander" },
  { nummer: "051", name: "Marx Udo" },
  { nummer: "053", name: "Karniszewski Antoni" },
  { nummer: "054", name: "L√∂wens Tobias" },
  { nummer: "055", name: "Schmidt Julian" },
  { nummer: "056", name: "Stoljanov Alan" },
  { nummer: "057", name: "Nguyen Hong" },
  { nummer: "058", name: "Teodescu Florin" },
  { nummer: "059", name: "Finder Waldemar" },
  { nummer: "060", name: "Riwert Alexander" },
  { nummer: "061", name: "Fast Valerien" },
  { nummer: "062", name: "Tansase Costel" },
  { nummer: "063", name: "Feraru, Nicolaie" },
  { nummer: "064", name: "Babarczik Raimund Otto" },
  { nummer: "065", name: "Gajfulin Dennis" },
  { nummer: "066", name: "Boico Anatolie" },
  { nummer: "067", name: "Boico Aurel" },
  { nummer: "068", name: "S√º√ü J√∂rg" },
  { nummer: "070", name: "Buga Nicolae" },
  { nummer: "071", name: "Honka Steven" },
  { nummer: "072", name: "Grigoryan Armen" },
  { nummer: "073", name: "Zyma Alexandru" },
  { nummer: "074", name: "Bruns Christoph" },
  { nummer: "075", name: "Bruns Christoph blaue Kleid." },
  { nummer: "076", name: "Slusnys Darius" },
  { nummer: "077", name: "Engelschmidt Torsten" },
  { nummer: "078", name: "Jafar, Hamed" },
  { nummer: "079", name: "Flore Sebastian" },
  { nummer: "080", name: "Babelek Adrian" },
  { nummer: "081", name: "Henneke Tobias" },
  { nummer: "082", name: "Flebbe Peter" },
  { nummer: "083", name: "Gorr Sergej" },
  { nummer: "084", name: "Trif Oliviu" },
  { nummer: "085", name: "Balzer Stefan" },
  { nummer: "086", name: "Paschkov Sergej" },
  { nummer: "087", name: "Erdmann Viktor" },
  { nummer: "088", name: "Masur J√∂rg" },
  { nummer: "089", name: "Ehlert Marco" },
  { nummer: "090", name: "Leongardt Evgenij" },
  { nummer: "091", name: "Norman Daniel" },
  { nummer: "093", name: "Andre Thorsten" },
  { nummer: "094", name: "David Heinrich" },
  { nummer: "095", name: "Bero Sulaiman" },
  { nummer: "097", name: "Weike, Dirk" },
  { nummer: "098", name: "Buzzi Adrian" },
  { nummer: "099", name: "Myroshychenko, Oleksandr" },
  { nummer: "0100", name: "Bukii Serhii" },
  { nummer: "0101", name: "Pr√º√ümann S√∂ren" },
  { nummer: "0102", name: "Zurm√ºhlen Marcel" },
  { nummer: "0103", name: "Cruz Juan" },
  { nummer: "0104", name: "Raschke Matthias (blau)" },
  { nummer: "0105", name: "Raschke Matthias" },
  { nummer: "0106", name: "Gutu Jonut" },
  { nummer: "0107", name: "Morris, Nathan" },
  { nummer: "0108", name: "H√∂ger Martin" },
  { nummer: "0109", name: "Florea Valentin" },
  { nummer: "0110", name: "Chochlov Pavel" },
  { nummer: "0111", name: "Bober, Rafal" },
  { nummer: "0112", name: "Mekonnen Belay, Tsehaye" },
  { nummer: "0113", name: "Plat Wilhelm" },
  { nummer: "0114", name: "Shevchenko Viktor" },
  { nummer: "0115", name: "Barthelmes Arne" },
  { nummer: "0117", name: "Duhm Oliver" },
  { nummer: "0118", name: "Manea Stelian" },
  { nummer: "0119", name: "Foti Giuseppe" },
  { nummer: "0120", name: "Ochlast Patrick" },
  { nummer: "0121", name: "Shipov, Mikhail" },
  { nummer: "0122", name: "Abbasov Azar" },
  { nummer: "0123", name: "Bero Haschem" },
  { nummer: "0124", name: "H√∂ffkes Rico" },
  { nummer: "0125", name: "Kazinakis Nikolaus" },
  { nummer: "0126", name: "Lacatus Florin" },
  { nummer: "0127", name: "Ciuculete Andrei" },
  { nummer: "0128", name: "Rose Thomas" },
  { nummer: "0129", name: "Oleksy Oliver" },
  { nummer: "0130", name: "Ciuculete George" },
  { nummer: "0131", name: "Villaroel Miguel" },
  { nummer: "0133", name: "Kalai Andrei" },
  { nummer: "0134", name: "Strajeriu Marius" },
  { nummer: "0135", name: "Prisacariu Robert" },
  { nummer: "0136", name: "Ureche Gheorge" },
  { nummer: "0137", name: "Strajeriu Ioan" },
  { nummer: "0138", name: "Beyer Kai-Olaf" },
  { nummer: "0139", name: "Micervicius Arunas" },
  { nummer: "0140", name: "Moldovan Claudiu" },
  { nummer: "0141", name: "Ivanov Ivan" },
  { nummer: "0142", name: "Palimaru Ionut" },
  { nummer: "0143", name: "Kulieyu Aliaksandr" },
  { nummer: "0145", name: "Vogt Michael" },
  { nummer: "0147", name: "Mihaila Florin" },
  { nummer: "0148", name: "Ibrahem Sami" },
  { nummer: "0149", name: "Constantin Daniel" },
  { nummer: "0150", name: "Cuttone Christian" },
  { nummer: "0151", name: "Wu Xinyang" },
  { nummer: "0152", name: "Lincan Marius" },
  { nummer: "0153", name: "Kirchberg, Rainer" },
  { nummer: "0154", name: "Sandri Cristian" },
  { nummer: "0155", name: "Shelia Paata" },
  { nummer: "0158", name: "Dimitrov, Vasil" },
  { nummer: "0160", name: "Sfiea Marian" },
  { nummer: "0165", name: "Manea Mirca" },
  { nummer: "0169", name: "Brill Niklas" },
  { nummer: "0180", name: "Micu Gheorghita" },
  { nummer: "0181", name: "Schulze Colin" },
  { nummer: "0182", name: "Heghedus Alexandru" },
  { nummer: "0184", name: "Kalai Gheorghe" },
  { nummer: "0186", name: "Lohvynenko Yurii" },
  { nummer: "0188", name: "Vozniuk Alexei" },
  { nummer: "0190", name: "Ivzhenko Denys" },
  { nummer: "0191", name: "Stypula Kevin" },
  { nummer: "0192", name: "Caracas Costel" },
  { nummer: "0196", name: "Lee Norman" },
  { nummer: "0197", name: "Slayoy Ognian" },
  { nummer: "0198", name: "Schmidtmann Dirk" },
  { nummer: "0199", name: "Motkow Oleksii" },
  { nummer: "0200", name: "Moldovan Dorel" },
  { nummer: "0205", name: "Ilinescu Constantin" },
  { nummer: "0231", name: "Starkov Dmytri" },
  { nummer: "0232", name: "Krois Eric" },
  { nummer: "0233", name: "Romanciuc, Iurie" },
  { nummer: "0242", name: "Bultoc Vasile" },
  { nummer: "998", name: "Wolter /Rathmann" },
  { nummer: "999", name: "Wulf Stephan /Rathmann" },
  { nummer: "851", name: "Pape Florian Heinrich" },
  { nummer: "852", name: "Henneke Tobias" },
  { nummer: "853", name: "Mai Benjamin" },
  { nummer: "854", name: "Guhl Arne" },
  { nummer: "855", name: "Ganswindt Stephan" },
  { nummer: "856", name: "Schmidt Julian" },
  { nummer: "800", name: "Merker Pascal" },
  { nummer: "801", name: "Bosselmann Uwe" },
  { nummer: "802", name: "Schemitko V." },
  { nummer: "803", name: "Teiwes Dirk" },
  { nummer: "804", name: "Mahlmann Udo" },
  { nummer: "805", name: "Eggers Tim" },
  { nummer: "806", name: "Leischner Felix" },
  { nummer: "807", name: "Klotz Walter" },
  { nummer: "810", name: "Ohm Maik" },
  { nummer: "811", name: "Pfeiffer Ronny" },
  { nummer: "812", name: "K√ºster Andreas" },
  { nummer: "813", name: "Timmermann J√ºrgen" },
  { nummer: "814", name: "Rosado Jesus" },
  { nummer: "815", name: "Graf Joachim" },
  { nummer: "816", name: "M√ºller-Seeling Constantin" },
  { nummer: "817", name: "Buske Martin" },
  { nummer: "818", name: "Hafermalz Mike" },
  { nummer: "819", name: "Kowald J√∂rg" },
  { nummer: "820", name: "Marciani Gino" },
  { nummer: "823", name: "Klaus Sergiej" },
  { nummer: "824", name: "Cuttone Allessandro" },
  { nummer: "825", name: "Busse Domenik" },
  { nummer: "835", name: "Arend Dimitriy" }
];
// Kategorie hinzuf√ºgen
frauenMitarbeiterListe.forEach(m => m.kategorie = "frauen");
maennerMitarbeiterListe.forEach(m => m.kategorie = "maenner");

// Vom Storage laden (nur eigene hinzugef√ºgte)
const gespeicherteZusatzMitarbeiter = JSON.parse(localStorage.getItem('mitarbeiterListe')) || [];
const mitarbeiterListe = [...frauenMitarbeiterListe, ...maennerMitarbeiterListe, ...gespeicherteZusatzMitarbeiter];





const artikel = [
  { name: "Sweatshirt Blau", nummer: "" },
  { name: "T-Shirt blau Art. Nr. 35JN001", nummer: "35JN001" },
  { name: "Bundhosen blau Art. 330100", nummer: "330100" },
  { name: "Latzhosen blau     Art. 330130", nummer: "330130" },
  { name: "Jacken blau", nummer: "" },
  { name: "Winterjacke gr√ºn", nummer: "" },
  { name: "Winterjacke f. Schlosser Art. Nr. 323195", nummer: "323195" },
  { name: "Blousonjacke", nummer: "" },
  { name: "ohne Petri-Aufn√§her", nummer: "" },
  { name: "Planam Fahrer Blousonjacke BW 290 mit Petri Aufn√§her Art. ¬¥0106054", nummer: "" },
  { name: "Winterjacke Fahrer Blouson Planam  wasserdicht Art. 2591048", nummer: "2591048" },
  { name: "Regenjacke dunkelblau", nummer: "" },
  { name: "Regenhose dunkelblau", nummer: "" },
  { name: "Latzhose gr√ºn", nummer: "" },
  { name: "Jacke orange", nummer: "" },
  { name: "alte Fahrer Bundhosen", nummer: "" },
  { name: "alte Fahrer Latzhosen", nummer: "" },
  { name: "alte Fahrer Blouson", nummer: "" },
  { name: "Kittel blau", nummer: "" },
  { name: "Kittel gr√ºn", nummer: "" },
  { name: "Kittel grau", nummer: "" },
  { name: "Fahrer Bundh.", nummer: "" },
  { name: "Fahrer Latzh.", nummer: "" },
  { name: "Planan Latzh.", nummer: "" },
  { name: "Fahrer Warnschutz Pilotenjacke              EL 86101R Yellow mit Petri Emblem/R√ºcken reflexsilber", nummer: "" },
  { name: "Schneehose Planam dunkelblau", nummer: "" },
  { name: "bl. Fleecejacke f. Fahrer etc. Nr. 339170", nummer: "339170" },
  { name: "Poloshirt schw.", nummer: "" },
  { name: "Sweatshirt schw.", nummer: "" },
  { name: "Hose schw. Kurz", nummer: "" },
  { name: "Hose schw. Lang", nummer: "" },
  { name: "Fleecejacke schw.", nummer: "" },
  { name: "Regenjacke schw. V. Elka", nummer: "" },
  { name: "Winterjacke schw.", nummer: "" },
  { name: "Unisex-Hosen wei√ü    Art.Nr. X-L12-6950", nummer: "X-L12-6950" },
  { name: "HAKRO Polo-Shirt wei√ü Art. Nr. 10008684 Best. Arbeitsschutzexpress", nummer: "10008684" },
  { name: "Sweatshirt wei√ü", nummer: "" },
  { name: "Kittel  KURZ  wei√ü", nummer: "" },
  { name: "Kittel LANG  wei√ü", nummer: "" },
  { name: "DA-Hosen wei√ü", nummer: "" },
  { name: "HE-Hosen wei√ü", nummer: "" },
  { name: "Taillenb√§nder Art. 15-99501 Kordel", nummer: "15-99501" },
  { name: "K√ºhlhausjacke marineblau von Hele PLANAM Art. 341100", nummer: "341100" },
  { name: "K√ºhlhausjacke blau von Hele PLANAM Art. 341100  --FREMDFIRMA\" auf √Ñrmel", nummer: "341100" },
  { name: "K√ºhlhausjacke blau von TEMPEX", nummer: "" },
  { name: "K√ºhlhausjacke wei√ü von TEMPEX", nummer: "" },
  { name: "Securesse Steppjacke wei√ü Art. 4711100 m. Kragen Art. 4711020 ohne Kragen", nummer: "4711100" },
  { name: "Securesse Steppweste wei√ü Art. 4711010", nummer: "4711010" },
  { name: "Securesse Stepphose Art. 4711030", nummer: "4711030" },
  { name: "Unterw√§sche Hose", nummer: "" },
  { name: "Unterw√§sche Shirt", nummer: "" },
  { name: "Stiefel WEI√ü  Art. Nr. 365A181331", nummer: "365A181331" },
  { name: "Stiefel wei√ü NEU blaue Sohle", nummer: "" },
  { name: "Stiefel GR√úN", nummer: "" },
  { name: "Schuhe Puma normal Art. Nr. 359640642", nummer: "359640642" },
  { name: "Schuhe Puma hoch Art. Nr. 359630182", nummer: "359630182" },
  { name: "Securesse  Art. Nr.  234053", nummer: "234053" },
  { name: "Schuhe", nummer: "" },
  { name: "Reste ABEBA", nummer: "" },
  { name: "ABEBA Hoch", nummer: "" },
  { name: "Securesse hoch", nummer: "" },
  { name: "Clogs", nummer: "" },
  { name: "Schuhe dunkelblau f. Fahrer, Lager, Schlosser, Hausmeister Art. Nr. 336060 Exena Monza", nummer: "336060" },
  { name: "Sixten Schuhe f. Schlosser halbhoch", nummer: "" },
  { name: "Schuhe dunkel f. Fahrer, Lager, Schlosser, Hausmeister Art. Nr.", nummer: "Nr" },
  { name: "Rest Schuhe dunkel", nummer: "" },
  { name: "Ersatzfu√übetten f√ºr Clogs", nummer: "" },
  { name: "Uvex Schuh", nummer: "" },
  { name: "Uvex Schuh", nummer: "" },
  { name: "Sixton CREMA", nummer: "" },
  { name: "Sixton Schn√ºrstiefel", nummer: "" },
  { name: "atlas Schuh", nummer: "" },
  { name: "Sixton", nummer: "" },
  { name: "Sixton Moivtauk Art. Nr. 3068115411 f. Hausm.", nummer: "3068115411" },
  { name: "Uvex 2 Xenova Sicherheitsstiefel Weite 11 Art. 35895562", nummer: "35895562" },
  { name: "Sixton Schn√ºrstiefel schw./blau Art. 3065302313", nummer: "3065302313" },
  { name: "Haix Sicherheitsschuh Blacksilver Art. 362630004", nummer: "362630004" },
  { name: "M√ºtze", nummer: "" },
  { name: "Cappy Art. 35CB15C", nummer: "35CB15C" },
  { name: "Einziehsocken              Art. Nr. 2103010", nummer: "2103010" },
  { name: "Buff Neckwarmer Art. NR. 483119403", nummer: "483119403" }
];

artikel.sort((a, b) => a.name.localeCompare(b.name));

    const groessen = ["XS", "S", "M", "L", "XL", "XXL", "XXXL", "XXXXL", "XXXXXL", "XXXXXXL","7", "8", "9", "10", "11", "28", "36", "37", "38", "39", "40", "41", "42", "43", "44", "45", "46", "47", "48", "49", "50", "52" , "54", "56", "58", "60", "62", "64", "66", "98", "104", "37/38", "39/40", "41/42","43/44","44/46", "45/46", "50/52", "52/54", "54/56", "58/60", "62/64"];
    let bestand = JSON.parse(localStorage.getItem('bestand')) || {};
    let history = JSON.parse(localStorage.getItem('history')) || [];
    let artikelStamm = JSON.parse(localStorage.getItem('artikelStamm')) || {};
    
function normalizeArtikelName(n) {
  return (n || "")
    .replace(/\u00A0/g, " ")          // NBSP -> normales Leerzeichen
    .replace(/\s+/g, " ")             // mehrere Spaces zu einem
    .replace(/\s*["']\s*auf\s*√Ñrmel.*$/i, "") // evtl. ‚Ä¶" auf √Ñrmel‚Ä¶ abschneiden
    .trim();
}
    function safeFileName(s) {
  return String(s)
    .replace(/[\\\/:*?"<>|#%&{}$!'@+`=]/g, "_") // verbotene Zeichen
    .replace(/\s+/g, "_")                       // Spaces -> _
    .slice(0, 120);                             // Sicherheitsl√§nge
}


function migrateBestandKeys() {
  const alt = JSON.stringify(bestand);

  const neu = {};
  Object.entries(bestand).forEach(([name, sizes]) => {
    const key = normalizeArtikelName(name);
    if (!neu[key]) neu[key] = {};
    Object.entries(sizes).forEach(([gr, qty]) => {
      const n = parseInt(qty) || 0;
      neu[key][gr] = (neu[key][gr] || 0) + n; // Mengen zusammenf√ºhren
    });
  });

  const neuStr = JSON.stringify(neu);
  const changed = alt !== neuStr;

  bestand = neu;
  localStorage.setItem('bestand', JSON.stringify(bestand));
  updateBestandTabelle();
  updateArtikelListe();

  if (changed) console.log("Bestandsschl√ºssel bereinigt.");
}


   

    function initSignatureCanvas(canvasId) {
      const canvas = document.getElementById(canvasId);
      const ctx = canvas.getContext("2d");
      let drawing = false;

 function resizeCanvas() {
  const ratio = window.devicePixelRatio || 1;
  canvas.width = canvas.offsetWidth * ratio;
  canvas.height = canvas.offsetHeight * ratio;
  ctx.setTransform(1, 0, 0, 1, 0, 0);
  ctx.lineWidth = 2;
  ctx.lineCap = "round";
}



      resizeCanvas();
      window.addEventListener("resize", resizeCanvas);

    function getPos(evt) {
  const rect = canvas.getBoundingClientRect();
  const ratio = window.devicePixelRatio || 1;

  if (evt.touches && evt.touches.length > 0) {
    return {
      x: (evt.touches[0].clientX - rect.left) * ratio,
      y: (evt.touches[0].clientY - rect.top) * ratio
    };
  } else {
    return {
      x: (evt.clientX - rect.left) * ratio,
      y: (evt.clientY - rect.top) * ratio
    };
  }
}


      canvas.addEventListener("mousedown", e => {
        drawing = true;
        const pos = getPos(e);
        ctx.beginPath();
        ctx.moveTo(pos.x, pos.y);
      });

      canvas.addEventListener("mousemove", e => {
        if (!drawing) return;
        const pos = getPos(e);
        ctx.lineTo(pos.x, pos.y);
        ctx.stroke();
      });

      canvas.addEventListener("mouseup", () => drawing = false);
      canvas.addEventListener("mouseout", () => drawing = false);

      canvas.addEventListener("touchstart", e => {
        drawing = true;
        const pos = getPos(e);
        ctx.beginPath();
        ctx.moveTo(pos.x, pos.y);
      });

      canvas.addEventListener("touchmove", e => {
        e.preventDefault();
        if (!drawing) return;
        const pos = getPos(e);
        ctx.lineTo(pos.x, pos.y);
        ctx.stroke();
      });

      canvas.addEventListener("touchend", () => drawing = false);
      canvas.addEventListener("touchcancel", () => drawing = false);
    }

    initSignatureCanvas("sigMitarbeiter");
    initSignatureCanvas("sigAusgabe");

function sucheNachID() {
  const id = document.getElementById("idInput").value.trim();
  const kategorie = document.getElementById("kategorieSelect").value;
  const quelle = mitarbeiterListe.filter(m => m.kategorie === kategorie);
  const eintrag = quelle.find(m => normSpind(m.nummer) === normSpind(id));
const feld = document.getElementById("mitarbeiterInput");
if (eintrag) {
  const sp = displaySpind(eintrag);
  feld.value = sp ? `${eintrag.name} (${sp})` : eintrag.name;
} else {
  feld.value = "";
}
} 





function addArtikel() {
  const container = document.getElementById("artikelContainer");
  const div = document.createElement("div");
  const artikelId = "artikel_" + Date.now();

  div.className = "artikel";
  div.innerHTML = `
    <button type="button" class="removeRow" title="Zeile entfernen">‚úñ</button>

    <label>Artikel:</label>
    <input list="artikelListeGlobal" class="artikelSuchfeld" data-artikelfeld="${artikelId}">
    <label>Gr√∂√üe:</label>
    <select>${groessen.map(g => `<option>${g}</option>`).join('')}</select>
    <label>Anzahl:</label>
    <input type="number" min="1" value="1">
    <label>Artikelnr.:</label>
    <input type="text" id="${artikelId}" readonly>
  `;

  container.appendChild(div);

  // Nummer automatisch aktualisieren
  const artikelInput = div.querySelector(".artikelSuchfeld");
  artikelInput.addEventListener("input", () => updateArtikelnummerInput(artikelInput));

  // Zeile entfernen
  const removeBtn = div.querySelector(".removeRow");
  removeBtn.addEventListener("click", () => div.remove());
}

function getArtikelNummer(name) {
  const key = normalizeArtikelName(name);
  const ausArray = artikel.find(a => normalizeArtikelName(a.name) === key)?.nummer;
  if (ausArray) return ausArray;
  return artikelStamm[key] || artikelStamm[name] || "";
}


    function updateArtikelnummerInput(inputElement) {
  const artikelName = inputElement.value;
  const feldId = inputElement.dataset.artikelfeld;
  const nummernfeld = document.getElementById(feldId);
  nummernfeld.value = getArtikelNummer(artikelName);
}

function updateArtikelnummer(selectElement) {
  const artikelName = selectElement.value;
  const feldId = selectElement.dataset.artikelfeld;
  const nummernfeld = document.getElementById(feldId);
  nummernfeld.value = getArtikelNummer(artikelName);
}


    function clearCanvas(id) {
      const canvas = document.getElementById(id);
      const ctx = canvas.getContext("2d");
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

// === iOS-Erkennung + PDF->Blob Helper ===
function isIOS() {
  const ua = navigator.userAgent || navigator.vendor || window.opera;
  return /iPad|iPhone|iPod/.test(ua) ||
         (navigator.platform === "MacIntel" && navigator.maxTouchPoints > 1);
}
function pdfToBlob(doc) {
  try { return doc.output("blob"); }
  catch { return new Blob([doc.output("arraybuffer")], { type: "application/pdf" }); }
}



async function loginAndUploadPDF(fileBlob, dateiname = "Dateiname.pdf") {
  try {
    const accessToken = await getAccessToken();
    const { driveId, folderId } = await ensureTargetIds();

    const uploadUrl =
      `https://graph.microsoft.com/v1.0/drives/${driveId}/items/${folderId}:/${encodeURIComponent(dateiname)}:/content?@microsoft.graph.conflictBehavior=rename`;

    const response = await fetch(uploadUrl, {
      method: "PUT",
      headers: {
        "Authorization": `Bearer ${accessToken}`,
        "Content-Type": "application/pdf"
      },
      body: fileBlob
    });

    if (!response.ok) {
      const msg = await response.text().catch(() => "");
      console.error("Upload error:", msg);
      alert("‚ùå Upload fehlgeschlagen.");
      return false;
    }
    return true;
  } catch (error) {
    console.error("‚ùå Login/Upload fehlgeschlagen", error);
    alert("‚ùå Fehler beim Login oder Upload");
    return false;
  }
}





async function abschliessen() {
  const mitarbeiterName = document.getElementById("mitarbeiterInput").value;
  const datum = document.getElementById("datum").value;
  const bemerkung = document.getElementById("bemerkung").value;
  const abteilung = document.getElementById("abteilung").value;
  const kategorie = document.getElementById("kategorieSelect").value;

  const ausgabeDetails = [];

  document.querySelectorAll("#artikelContainer .artikel").forEach(div => {
    const artikelInput = div.querySelector(".artikelSuchfeld");
    const groesse = div.querySelector("select:nth-of-type(1)").value;
    const inputAnzahl = div.querySelector("input[type='number']");
    const artikelName = artikelInput.value;
    const anzahl = parseInt(inputAnzahl.value, 10) || 0;

    const nameKey = normalizeArtikelName(artikelName);
    if (!nameKey || anzahl <= 0) return;

    if (!bestand[nameKey]) bestand[nameKey] = {};
    if (bestand[nameKey][groesse] === undefined) bestand[nameKey][groesse] = 0;

    const alt = parseInt(bestand[nameKey][groesse], 10) || 0;
    bestand[nameKey][groesse] = Math.max(alt - anzahl, 0);

    history.push({
      datum: datum || new Date().toISOString().split('T')[0],
      mitarbeiter: mitarbeiterName,
      artikel: artikelName,
      groesse: groesse,
      anzahl: anzahl
    });

    ausgabeDetails.push(`${artikelName} (${groesse}) - ${anzahl} Stk.`);
  });

  localStorage.setItem('bestand', JSON.stringify(bestand));
  localStorage.setItem('history', JSON.stringify(history));
  updateBestandTabelle();
  updateDashboard();

 try {
  await generatePDF(mitarbeiterName, datum, ausgabeDetails, bemerkung, abteilung, kategorie);
} catch (e) {

    console.error(e);
    alert("‚ùå PDF/Upload fehlgeschlagen.");
    return; // kein Reload bei Fehler
  }

  document.getElementById("artikelContainer").innerHTML = "";
  document.getElementById("bemerkung").value = "";
  clearCanvas('sigMitarbeiter');
  clearCanvas('sigAusgabe');

  alert("‚úÖ Ausgabe abgeschlossen, Bestand aktualisiert und PDF in OneDrive gespeichert.");
  location.reload();
}





async function generatePDF(mitarbeiter, datum, details, bemerkung, abteilung, kategorie) {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  // Anzeige
  const empfaengerText = (kategorie === "produktion") ? "Abteilung: " + abteilung : mitarbeiter;
  const empfaengerKey  = (kategorie === "produktion") ? `Abteilung_${abteilung}` : mitarbeiter;
  const dateStr = datum || new Date().toISOString().split('T')[0];

  doc.setFontSize(14);
  doc.text("W√§scheausgabe Beleg", 10, 20);
  doc.text(`Empf√§nger: ${empfaengerText}`, 10, 30);
  doc.text(`Kategorie: ${kategorie}`, 10, 40);
  doc.text(`Abteilung: ${abteilung}`, 10, 50);
  doc.text(`Datum: ${dateStr}`, 10, 60);
  doc.text("Artikel:", 10, 70);

  details.forEach((line, index) => {
    doc.text(line, 10, 80 + index * 10);
  });

  doc.text(`Bemerkung: ${bemerkung}`, 10, 90 + details.length * 10);

  const canvasM = document.getElementById("sigMitarbeiter");
  const imgM = canvasM.toDataURL("image/png");
  doc.text("Unterschrift Mitarbeiter:", 10, 100 + details.length * 10);
  doc.addImage(imgM, "PNG", 10, 110 + details.length * 10, 80, 30);

  const canvasA = document.getElementById("sigAusgabe");
  const imgA = canvasA.toDataURL("image/png");
  doc.text("Unterschrift Ausgabe:", 10, 145 + details.length * 10);
  doc.addImage(imgA, "PNG", 10, 155 + details.length * 10, 80, 30);

  // ---------- hier der wichtige Teil ----------
  const fileName = safeFileName(`Ausgabe_${empfaengerKey}_${dateStr}.pdf`);

  // Safari/iOS mag manchmal output("blob") nicht ‚Üí Fallback nutzen
  const pdfBlob = pdfToBlob(doc);  // nutzt die Hilfsfunktion

  // 1) Immer erst in OneDrive hochladen
  const ok = await loginAndUploadPDF(pdfBlob, fileName);
  if (ok === false) throw new Error("Upload fehlgeschlagen");

  // 2) Nur auf Nicht-iOS zus√§tzlich lokal speichern
  if (!isIOS()) {
    doc.save(fileName);
  } else {
    console.log("iOS erkannt ‚Äì kein lokaler Download, nur OneDrive-Upload.");
  }
}







async function generateRueckgabePDF(mitarbeiter, datum, details, bemerkung, abteilung, kategorie) {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  const empfaengerText = (kategorie === "produktion") ? "Abteilung: " + abteilung : mitarbeiter;
  const empfaengerKey  = (kategorie === "produktion") ? `Abteilung_${abteilung}` : mitarbeiter;
  const dateStr = datum || new Date().toISOString().split('T')[0];

  doc.setFontSize(14);
  doc.text("W√§sche-R√ºckgabe Beleg", 10, 20);
  doc.text(`Empf√§nger: ${empfaengerText}`, 10, 30);
  doc.text(`Kategorie: ${kategorie}`, 10, 40);
  doc.text(`Abteilung: ${abteilung}`, 10, 50);
  doc.text(`Datum: ${dateStr}`, 10, 60);
  doc.text("Artikel:", 10, 70);

  details.forEach((line, index) => {
    doc.text(line, 10, 80 + index * 10);
  });

  doc.text(`Bemerkung: ${bemerkung}`, 10, 90 + details.length * 10);

  const canvasM = document.getElementById("sigMitarbeiter");
  const imgM = canvasM.toDataURL("image/png");
  doc.text("Unterschrift Mitarbeiter:", 10, 100 + details.length * 10);
  doc.addImage(imgM, "PNG", 10, 110 + details.length * 10, 80, 30);

  const canvasA = document.getElementById("sigAusgabe");
  const imgA = canvasA.toDataURL("image/png");
  doc.text("Unterschrift R√ºcknahme:", 10, 145 + details.length * 10);
  doc.addImage(imgA, "PNG", 10, 155 + details.length * 10, 80, 30);

  // Dateiname
  const rawName  = `Rueckgabe_${empfaengerKey}_${dateStr}.pdf`;
  const fileName = safeFileName(rawName);

  // 1) Blob erstellen (iOS-sicher)
  const pdfBlob = pdfToBlob(doc);

  // 2) Erst OneDrive-Upload
  const ok = await loginAndUploadPDF(pdfBlob, fileName);
  if (!ok) throw new Error("Upload fehlgeschlagen");

  // 3) Nur auf Nicht-iOS zus√§tzlich lokal speichern
  if (!isIOS()) {
    doc.save(fileName);
  }

  return true;
}






async function rueckgabeAbschliessen() {
  const mitarbeiterName = document.getElementById("mitarbeiterInput").value;
  const datum = document.getElementById("datum").value;
  const bemerkung = document.getElementById("bemerkung").value;
  const abteilung = document.getElementById("abteilung").value;
  const kategorie = document.getElementById("kategorieSelect").value;

  const rueckgabeDetails = [];

  document.querySelectorAll("#artikelContainer .artikel").forEach(div => {
    const artikelInput = div.querySelector(".artikelSuchfeld");
    const groesse = div.querySelector("select:nth-of-type(1)").value;
    const inputAnzahl = div.querySelector("input[type='number']");
    const artikelName = artikelInput.value;
    const anzahl = parseInt(inputAnzahl.value, 10) || 0;

    const nameKey = normalizeArtikelName(artikelName);
    if (!nameKey || anzahl <= 0) return;

    if (!bestand[nameKey]) bestand[nameKey] = {};
    if (bestand[nameKey][groesse] === undefined) bestand[nameKey][groesse] = 0;

    bestand[nameKey][groesse] += anzahl;

    history.push({
      datum: datum || new Date().toISOString().split('T')[0],
      mitarbeiter: mitarbeiterName,
      artikel: artikelName,
      groesse: groesse,
      anzahl: anzahl,
      rueckgabe: true
    });

    rueckgabeDetails.push(`${artikelName} (${groesse}) - ${anzahl} Stk.`);
  });

  localStorage.setItem('bestand', JSON.stringify(bestand));
  localStorage.setItem('history', JSON.stringify(history));
  updateBestandTabelle();
  updateDashboard();

  try {
    await generateRueckgabePDF(mitarbeiterName, datum, rueckgabeDetails, bemerkung, abteilung, kategorie);
  } catch (e) {
    console.error(e);
    alert("‚ùå PDF/Upload fehlgeschlagen.");
    return; // Kein Reset/Reload bei Fehler
  }

  document.getElementById("artikelContainer").innerHTML = "";
  document.getElementById("bemerkung").value = "";
  clearCanvas('sigMitarbeiter');
  clearCanvas('sigAusgabe');

  alert("‚úÖ R√ºckgabe abgeschlossen, Bestand aktualisiert und PDF in OneDrive gespeichert.");
  location.reload();
}





function saveBestand() {
  const neu = {};
  const seenOriginalKeys = new Set();

  document.querySelectorAll("#bestandTabelle tbody tr").forEach(row => {
    const nameInput    = row.querySelector(".name-input");
    const groesseInput = row.querySelector(".groesse-input");
    const qtyInput     = row.querySelector(".bestand-input");
    if (!nameInput || !groesseInput || !qtyInput) return;

    const newNameRaw = (nameInput.value || "").trim();
    const newKey     = normalizeArtikelName(newNameRaw);
    const size       = (groesseInput.value || "").trim();
    let qty          = parseInt(qtyInput.value, 10);
    if (isNaN(qty)) qty = 0;
    if (qty < 0) qty = 0;                  // keine negativen Best√§nde
    if (!newKey || !size) return;

    if (!neu[newKey]) neu[newKey] = {};
    neu[newKey][size] = (neu[newKey][size] || 0) + qty;

    // Artikelnr. beim Umbenennen mitnehmen
    const origKey = normalizeArtikelName(nameInput.dataset.originalName || newNameRaw);
    if (origKey && artikelStamm[origKey] && !artikelStamm[newKey]) {
      artikelStamm[newKey] = artikelStamm[origKey];
    }
    if (origKey) seenOriginalKeys.add(origKey);
  });

  // Eintr√§ge mit Menge 0 entfernen
  Object.keys(neu).forEach(name => {
    Object.keys(neu[name]).forEach(gr => {
      if ((parseInt(neu[name][gr], 10) || 0) <= 0) delete neu[name][gr];
    });
    if (Object.keys(neu[name]).length === 0) delete neu[name];
  });

  // Alte artikelStamm-Keys aufr√§umen, wenn Name komplett verschwunden ist
  seenOriginalKeys.forEach(orig => {
    if (artikelStamm[orig] && !neu[orig]) delete artikelStamm[orig];
  });

  bestand = neu;
  localStorage.setItem("bestand", JSON.stringify(bestand));
  localStorage.setItem("artikelStamm", JSON.stringify(artikelStamm));

  updateBestandTabelle();
  updateArtikelListe();
  if (typeof saveDataToOneDrive === "function") saveDataToOneDrive();

  alert("‚úÖ Alle √Ñnderungen gespeichert.");
}



function updateBestandTabelle() {
  const tbody = document.querySelector("#bestandTabelle tbody");
  tbody.innerHTML = "";

  const names = Object.keys(bestand).sort((a, b) => a.localeCompare(b, "de"));
  names.forEach(name => {
    const sizes = Object.keys(bestand[name]).sort((a, b) =>
      a.localeCompare(b, "de", { numeric: true, sensitivity: "base" })
    );

    sizes.forEach(groesse => {
      const tr = document.createElement("tr");

      // Spalte: Artikelname
      const tdName = document.createElement("td");
      const inpName = document.createElement("input");
      inpName.type = "text";
      inpName.className = "name-input";
      inpName.value = name;
      inpName.dataset.originalName = name; // f√ºr saveArtikel()
      inpName.dataset.groesse = groesse;   // f√ºr saveArtikel()
      tdName.appendChild(inpName);

      // Spalte: Gr√∂√üe
      const tdSize = document.createElement("td");
      const inpSize = document.createElement("input");
      inpSize.type = "text";
      inpSize.className = "groesse-input";
      inpSize.value = groesse;
      tdSize.appendChild(inpSize);

      // Spalte: Bestand
      const tdQty = document.createElement("td");
      const inpQty = document.createElement("input");
      inpQty.type = "number";
      inpQty.className = "bestand-input";
      inpQty.min = "0";
      inpQty.step = "1";
      inpQty.value = parseInt(bestand[name][groesse], 10) || 0;
      tdQty.appendChild(inpQty);

      // Spalte: Aktionen
      const tdActions = document.createElement("td");
      const btnSave = document.createElement("button");
      btnSave.textContent = "Speichern";
      btnSave.addEventListener("click", () => saveArtikel(btnSave));

      const btnDel = document.createElement("button");
      btnDel.textContent = "L√∂schen";
      btnDel.addEventListener("click", () => deleteArtikel(btnDel));

      tdActions.appendChild(btnSave);
      tdActions.appendChild(btnDel);

      tr.appendChild(tdName);
      tr.appendChild(tdSize);
      tr.appendChild(tdQty);
      tr.appendChild(tdActions);

      tbody.appendChild(tr);
    });
  });
}


function updateArtikelListe() {
  const names = new Set();

  // aus dem festen Array
  artikel.forEach(a => {
    const n = (a.name || "").trim();
    if (n) names.add(n);
  });

  // aus deinem Bestand (manuell hinzugef√ºgt)
  Object.keys(bestand || {}).forEach(n => {
    n = (n || "").trim();
    if (n) names.add(n);
  });

  const dl = document.querySelector("#artikelListeGlobal");
  dl.innerHTML = [...names]
    .sort((a, b) => a.localeCompare(b))
    .map(n => `<option value="${n}">`)
    .join("");
}






function saveArtikel(button) {
  const row = button.closest("tr");

  const nameInput = row.querySelector(".name-input");
  const groesseInput = row.querySelector(".groesse-input");
  const bestandInput = row.querySelector(".bestand-input");

  // Alte Werte aus den data-Attributen (so wurde die Zeile erstellt)
  const originalName = nameInput.dataset.originalName;
  const alteGroesse = nameInput.dataset.groesse;

  // Neue Werte aus dem Formular
  const newNameRaw = nameInput.value.trim();
  const newGroesse = groesseInput.value.trim();
  const newBestand = parseInt(bestandInput.value, 10) || 0;

  // Normalisierte Keys, damit keine Altlasten entstehen
  const originalKey = normalizeArtikelName(originalName);
  const newKey = normalizeArtikelName(newNameRaw);

  if (!newKey) {
    alert("Artikelname darf nicht leer sein!");
    return;
  }

  // Ziel-Eintrag anlegen/setzen
  if (!bestand[newKey]) bestand[newKey] = {};
  bestand[newKey][newGroesse] = newBestand;

  // Alten Eintrag l√∂schen, wenn Name oder Gr√∂√üe ge√§ndert wurden
  if (newKey !== originalKey || newGroesse !== alteGroesse) {
    if (bestand[originalKey] && bestand[originalKey][alteGroesse] !== undefined) {
      delete bestand[originalKey][alteGroesse];
      if (Object.keys(bestand[originalKey]).length === 0) {
        delete bestand[originalKey];
      }
    }
  }

  // Artikelnummer im Stamm bei Namens√§nderung "mitnehmen"
  if (newKey !== originalKey && artikelStamm[originalKey]) {
    if (!artikelStamm[newKey]) {
      artikelStamm[newKey] = artikelStamm[originalKey];
    }
    delete artikelStamm[originalKey];
    localStorage.setItem("artikelStamm", JSON.stringify(artikelStamm));
  }

  // Speichern & UI aktualisieren
  localStorage.setItem('bestand', JSON.stringify(bestand));
  updateBestandTabelle();
  updateArtikelListe();
  if (typeof saveDataToOneDrive === "function") saveDataToOneDrive();

  // Die neuen "Original"-Werte zur√ºck in die data-Attribute schreiben
  nameInput.dataset.originalName = newNameRaw;
  nameInput.dataset.groesse = newGroesse;

  alert("‚úÖ Artikel gespeichert.");
}


function addNeuerArtikel() {
  const nameRaw = document.getElementById("neuerName").value.trim();
  const name = normalizeArtikelName(nameRaw);                 // üëà neu
  const groesse = document.getElementById("neueGroesse").value.trim();
  const bestandWert = parseInt(document.getElementById("neuerBestand").value, 10) || 0;
  const nummer = (document.getElementById("neueNummer").value || "").trim();

  if (!name || !groesse) {
    alert("‚ùå Bitte Name und Gr√∂√üe angeben.");
    return;
  }

  // Bestand setzen (oder anlegen)
  if (!bestand[name]) bestand[name] = {};
  bestand[name][groesse] = bestandWert;                       // (optional unten: addieren statt √ºberschreiben)

  // Artikelnr. speichern (nur wenn angegeben)
  if (nummer) {
    artikelStamm[name] = nummer;
    localStorage.setItem("artikelStamm", JSON.stringify(artikelStamm));
  }

  // Persistenz & UI
  localStorage.setItem("bestand", JSON.stringify(bestand));
  updateBestandTabelle();
  updateArtikelListe();
  if (typeof saveDataToOneDrive === "function") saveDataToOneDrive();

  // Felder leeren
  document.getElementById("neuerName").value = "";
  document.getElementById("neueGroesse").value = "";
  document.getElementById("neueNummer").value = "";
  document.getElementById("neuerBestand").value = "";

  alert("‚úÖ Neuer Artikel hinzugef√ºgt.");
}


function filterBestandTabelle() {
  const suchbegriff = document.getElementById("bestandSuche").value.toLowerCase();
  const rows = document.querySelectorAll("#bestandTabelle tbody tr");

  rows.forEach(row => {
    const artikel = row.querySelector(".name-input")?.value.toLowerCase() || "";
    const groesse = row.querySelector(".groesse-input")?.value.toLowerCase() || "";
    
    const sichtbar = artikel.includes(suchbegriff) || groesse.includes(suchbegriff);
    row.style.display = sichtbar ? "" : "none";
  });
}



function deleteArtikel(button) {
  const row = button.closest("tr");
  const rawName = row.querySelector(".name-input")?.value.trim();
  const groesse = row.querySelector(".groesse-input")?.value.trim();
  const name = normalizeArtikelName(rawName);

  if (!name || !groesse) {
    alert("‚ùå Artikelname oder Gr√∂√üe fehlen.");
    return;
  }
  if (!confirm(`‚ùå Wirklich l√∂schen: ${rawName} (${groesse})?`)) return;

  if (bestand[name] && bestand[name][groesse] !== undefined) {
    delete bestand[name][groesse];
    if (Object.keys(bestand[name]).length === 0) delete bestand[name];
    localStorage.setItem("bestand", JSON.stringify(bestand));
    updateBestandTabelle(); updateArtikelListe();
    if (typeof saveDataToOneDrive === "function") saveDataToOneDrive();
    alert(`‚úÖ ${rawName} (${groesse}) wurde gel√∂scht.`);
  } else {
    alert("‚ùå Artikel nicht gefunden.");
  }
}






 

    // üëâ Nur EINMAL definieren ‚Äî die Version mit 30 Tage und Buttons

let zeigeAlle = false;

function updateDashboard() {
  const tbody = document.querySelector("#dashboardTabelle tbody");
  tbody.innerHTML = "";

  const nameFilter = document.getElementById("dashboardSearch").value.toLowerCase();
  const startDate = document.getElementById("startDate").value;
  const endDate = document.getElementById("endDate").value;

  let filteredHistory = [...history];
  if (!zeigeAlle) {
    const heute = new Date();
    const vor30Tagen = new Date();
    vor30Tagen.setDate(heute.getDate() - 30);

    filteredHistory = filteredHistory.filter(entry => {
      const entryDate = new Date(entry.datum);
      return entryDate >= vor30Tagen && entryDate <= heute;
    });
  }

  filteredHistory.forEach(entry => {
    const mitarbeiter = entry.mitarbeiter.toLowerCase();
    if (nameFilter && !mitarbeiter.includes(nameFilter)) return;
    if (startDate && entry.datum < startDate) return;
    if (endDate && entry.datum > endDate) return;

    const row = document.createElement("tr");
    row.innerHTML = `<td>${entry.datum}</td><td>${entry.mitarbeiter}</td><td>${entry.artikel}</td><td>${entry.groesse}</td><td>${entry.anzahl}</td>`;
    tbody.appendChild(row);
  });
}

// Buttons hinzuf√ºgen
const dashboardContainer = document.querySelector(".dashboard-container");
const btnAlle = document.createElement("button");
btnAlle.textContent = "Alle anzeigen";
btnAlle.onclick = () => {
  zeigeAlle = true;
  updateDashboard();
};

const btn30 = document.createElement("button");
btn30.textContent = "Letzte 30 Tage anzeigen";
btn30.onclick = () => {
  zeigeAlle = false;
  updateDashboard();
};

dashboardContainer.insertBefore(btnAlle, dashboardContainer.children[dashboardContainer.children.length - 1]);
dashboardContainer.insertBefore(btn30, dashboardContainer.children[dashboardContainer.children.length - 1]);


    function filterDashboard() {
      const nameFilter = document.getElementById("dashboardSearch").value.toLowerCase();
      const startDate = document.getElementById("startDate").value;
      const endDate = document.getElementById("endDate").value;

      const rows = document.querySelectorAll("#dashboardTabelle tbody tr");
      rows.forEach(row => {
        const mitarbeiter = row.children[1].innerText.toLowerCase();
        const datum = row.children[0].innerText;

        let show = mitarbeiter.includes(nameFilter);

        if (startDate) {
          show = show && (datum >= startDate);
        }
        if (endDate) {
          show = show && (datum <= endDate);
        }

        row.style.display = show ? "" : "none";
      });
    }







function toggleBestandAnzeige() {
  const container = document.querySelector(".bestand-container");
  const btn = document.getElementById("toggleBestandBtn");
  if (container.style.display === "none" || container.style.display === "") {
    container.style.display = "block";
    btn.textContent = "Bestand ausblenden";
  } else {
    container.style.display = "none";
    btn.textContent = "Bestand anzeigen";
  }
}
function toggleDashboardAnzeige() {
  const container = document.querySelector(".dashboard-container");
  const btn = document.getElementById("toggleDashboardBtn");
  if (container.style.display === "none" || container.style.display === "") {
    container.style.display = "block";
    btn.textContent = "Dashboard ausblenden";
  } else {
    container.style.display = "none";
    btn.textContent = "Dashboard anzeigen";
  }
}

function toggleFreieSpindnummern() {
  const container = document.getElementById("freieSpindnummernContainer");
  const btn = document.getElementById("toggleSpindBtn");
  
  if (container.style.display === "none" || container.style.display === "") {
    // Anzeigen
    zeigeFreieSpindnummern(); // Liste erzeugen
    container.style.display = "block";
    btn.textContent = "Freie Spindnummern ausblenden";
  } else {
    // Ausblenden
    container.style.display = "none";
    btn.textContent = "Freie Spindnummern anzeigen";
  }
}



window.addEventListener("DOMContentLoaded", () => {
  migrateBestandKeys();   // ‚Üê zuerst bereinigen
  kategorieWechsel();
  updateBestandTabelle();
  updateDashboard();
  renderMitarbeiterTabelle();
  updateArtikelListe();

  document.querySelector(".bestand-container").style.display = "none";
  document.getElementById("toggleBestandBtn").textContent = "Bestand anzeigen";

  document.querySelector(".dashboard-container").style.display = "none";
  document.getElementById("toggleDashboardBtn").textContent = "Dashboard anzeigen";

  // üü† Automatisch laden
 // loadDataFromOneDrive();
});




// Mitarbeiterarray aus localStorage laden oder leeres Array



// ‚úÖ Funktion ist global verf√ºgbar
function addMitarbeiter() {
  const nameInput = document.getElementById("neuerMitarbeiterName");
  const spindInput = document.getElementById("neuerSpind");
  const kategorieInput = document.getElementById("neueKategorie");
  const startInput = document.getElementById("neuerStart");

  if (!nameInput || !spindInput || !kategorieInput || !startInput) {
    alert("‚ùå Eingabefelder nicht gefunden!");
    return;
  }

  const name = (nameInput.value || "").trim();
  const kategorie = kategorieInput.value;
  let spind = (spindInput.value || "").trim();

  // Name ist Pflicht, Spind darf leer sein
  if (!name) {
    alert("‚ùå Bitte Name eingeben!");
    return;
  }

  // Spind normalisieren (nur Ziffern), darf leer bleiben
  spind = spind ? spind.replace(/\D/g, "") : "";

  // M√§nner: f√ºhrende 0 nur setzen, wenn √ºberhaupt eine Spind angegeben ist
  if (kategorie === "maenner" && spind) {
    if (!/^0/.test(spind)) spind = "0" + spind;
  }

  // Duplikate pr√ºfen
  if (spind) {
    // Spind darf in dieser Kategorie nicht schon vergeben sein
    if (mitarbeiterListe.some(m => (m.kategorie === kategorie) && normSpind(m.nummer) === normSpind(spind))) {
      alert("‚ùå Diese Spindnummer ist in dieser Kategorie bereits vergeben.");
      return;
    }
    // Exakte Dopplung (Name+Spind+Kategorie) verhindern
    if (mitarbeiterListe.some(m => m.kategorie === kategorie && m.name === name && (m.nummer || "") === spind)) {
      alert("‚ùå Dieser Mitarbeiter existiert bereits.");
      return;
    }
  } else {
    // Ohne Spind: gleicher Name ohne Spind in gleicher Kategorie verhindern
    if (mitarbeiterListe.some(m => m.kategorie === kategorie && m.name === name && !m.nummer)) {
      alert("‚ùå Dieser Mitarbeiter (ohne Spind) existiert bereits.");
      return;
    }
  }

  // Speichern (nummer darf leer sein)
  mitarbeiterListe.push({ name, nummer: spind, kategorie, start: startInput.value });

  const zusatzMitarbeiter = mitarbeiterListe.filter(m =>
    !frauenMitarbeiterListe.find(f => f.name === m.name && f.nummer === m.nummer) &&
    !maennerMitarbeiterListe.find(ma => ma.name === m.name && ma.nummer === m.nummer)
  );
  localStorage.setItem('mitarbeiterListe', JSON.stringify(zusatzMitarbeiter));

  // Gesamtliste sauber neu zusammensetzen
  mitarbeiterListe.length = 0;
  mitarbeiterListe.push(...frauenMitarbeiterListe, ...maennerMitarbeiterListe, ...zusatzMitarbeiter);

  renderMitarbeiterTabelle();
  updateMitarbeiterDatalist();
  kategorieWechsel();
  zeigeFreieSpindnummern();
  if (typeof saveDataToOneDrive === "function") saveDataToOneDrive();

  // Felder zur√ºcksetzen
  nameInput.value = "";
  spindInput.value = "";
  kategorieInput.value = "frauen";
  startInput.value = "";

  alert("‚úÖ Mitarbeiter erfolgreich hinzugef√ºgt.");
}


// ‚úÖ DOMContentLoaded bleibt f√ºr andere Funktionen
document.addEventListener("DOMContentLoaded", function () {
  // Hier z.‚ÄØB. initiale Funktionen aufrufen, z.‚ÄØB.:
  updateMitarbeiterDatalist();
});











 

function deleteMitarbeiter(index) {
  if (!confirm("Mitarbeiter wirklich l√∂schen?")) return;

  mitarbeiterListe.splice(index, 1);

  const zusatzMitarbeiter = mitarbeiterListe.filter(m =>
    !frauenMitarbeiterListe.find(f => f.name === m.name && f.nummer === m.nummer) &&
    !maennerMitarbeiterListe.find(ma => ma.name === m.name && ma.nummer === m.nummer)
  );
  localStorage.setItem('mitarbeiterListe', JSON.stringify(zusatzMitarbeiter));

  renderMitarbeiterTabelle();
  updateMitarbeiterDatalist();
  kategorieWechsel();
  zeigeFreieSpindnummern();
  if (typeof saveDataToOneDrive === "function") saveDataToOneDrive();
}




function zeigeFreieSpindnummern() {
  const kategorie = document.getElementById("neueKategorie").value;
  const container = document.getElementById("freieSpindnummernContainer");

  // Statische Listen
  const frauenFreie = [
    "5", "18", "45", "101", "102", "105", "106", "107", "109", "110",
    "112", "113", "114", "115", "116", "117", "118", "119", "120", "121",
    "122", "123", "124", "125", "126", "127", "128", "129", "130", "140",
    "161", "162", "163", "164", "165", "166", "167", "168", "169", "170",
    "171", "172", "173"
  ];

  const maennerFreie = [
    "07", "019", "032", "039", "052", "069", "092", "096", "0116", "0132",
    "0144", "0146", "0187", "0189", "0193", "0194", "0201", "0202", "0203",
    "0204", "0206", "0207", "0211", "0222", "0223", "0224", "0225", "0227",
    "0228", "0229", "0230", "0234", "0236", "0237", "0238", "0239", "0240",
    "0241", "0243", "0244", "0245", "0246", "0247", "0248", "0249", "0250",
    "0251", "0252", "0253", "0254", "0255", "0256", "0257", "0258", "0259",
    "0260", "858", "859", "860"
  ];

  let alleFreien = [];
if (kategorie === "frauen") {
  alleFreien = frauenFreie;
} else if (kategorie === "maenner") {
  alleFreien = maennerFreie;
} else if (kategorie === "zeitarbeiter") {
  alleFreien = []; // Leere Liste f√ºr Zeitarbeiter
}


  // Spindnummern aus aktueller Liste entfernen
  const belegte = mitarbeiterListe
    .filter(m => m.kategorie === kategorie)
    .map(m => m.nummer);

  const wirklichFrei = alleFreien.filter(num => !belegte.includes(num));

  container.innerHTML = wirklichFrei.join("<br>");
}








// üîπ Helfer oben einmal definieren
function normSpind(s) {
  const d = String(s || "").replace(/\D/g, "");
  return d ? String(parseInt(d, 10)) : "";
}
function displaySpind(m) {
  const raw = String(m?.nummer ?? "").trim();
  if (!raw) return "";                         // keine Spind hinterlegt
  const digits = raw.replace(/\D/g, "");
  if (!digits) return "";

  if ((m.kategorie || "") === "maenner") {
    // Wenn schon mit 0 gespeichert, so lassen ‚Äì sonst 0 voranstellen
    return raw.startsWith("0") ? raw : "0" + digits;
  }
  // Frauen/Zeitarbeiter: nur Ziffern anzeigen
  return digits;
}


function renderMitarbeiterTabelle() {
  const tbody = document.querySelector("#mitarbeiterTabelle tbody");
  const gewaehlteKat = document.getElementById("mitarbeiterKategorieFilter")?.value || "alle";

  // Basisliste ggf. nach Kategorie filtern
  let liste = [...mitarbeiterListe];
  if (gewaehlteKat !== "alle") {
    liste = liste.filter(m => (m.kategorie || "") === gewaehlteKat);
  }

  // Sortierung wie bisher (Spind numerisch, dann Name)
  liste.sort((a, b) => {
    const na = parseInt(normSpind(a.nummer) || "0", 10);
    const nb = parseInt(normSpind(b.nummer) || "0", 10);
    if (na !== nb) return na - nb;
    return a.name.localeCompare(b.name);
  });

  // Tabelle neu aufbauen
  tbody.innerHTML = "";
  liste.forEach(m => {
    const idx = mitarbeiterListe.findIndex(x =>
      x.name === m.name && x.nummer === m.nummer && x.kategorie === m.kategorie
    );
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${m.name}</td>
     <td>${displaySpind(m) || "-"}</td>

      <td>${m.kategorie || '-'}</td>
      <td><button onclick="deleteMitarbeiter(${idx})">L√∂schen</button></td>
    `;
    tbody.appendChild(row);
  });

  // bereits eingegebenen Suchtext direkt anwenden
  filterMitarbeiterTabelle();
}



function filterMitarbeiterTabelle() {
  const filter = document.getElementById("mitarbeiterSearch").value.toLowerCase();
  const rows = document.querySelectorAll("#mitarbeiterTabelle tbody tr");
  
  rows.forEach(row => {
    const name = row.children[0].innerText.toLowerCase();
    const spind = row.children[1].innerText.toLowerCase();
    const match = name.includes(filter) || spind.includes(filter);
    row.style.display = match ? "" : "none";
  });
}

let loadInProgress = false; // global definieren

async function loadDataFromOneDrive() {
  if (loadInProgress) return;
  loadInProgress = true;

  try {
    const accessToken = await getAccessToken();
    const { driveId, folderId } = await ensureTargetIds();

    const url = `https://graph.microsoft.com/v1.0/drives/${driveId}/items/${folderId}:/bestand.json:/content`;
    const res = await fetch(url, {
      method: "GET",
      headers: { Authorization: `Bearer ${accessToken}` }
    });

    if (res.status === 404) {
      alert("‚ÑπÔ∏è 'bestand.json' wurde noch nicht angelegt ‚Äì es gibt noch keine Cloud-Daten.");
      return;
    }
    if (!res.ok) throw new Error(await res.text());

    const data = await res.json();

    bestand = data.bestand || {};
    history = data.history || [];
    const neueZusatz = data.mitarbeiterListe || [];

    // ‚¨áÔ∏è WICHTIG: Liste im Speicher neu zusammensetzen
    mitarbeiterListe.length = 0;
    mitarbeiterListe.push(
      ...frauenMitarbeiterListe,
      ...maennerMitarbeiterListe,
      ...neueZusatz
    );

    // optional: zus√§tzlich im LocalStorage ablegen (kann bleiben)
    localStorage.setItem('bestand', JSON.stringify(bestand));
    localStorage.setItem('history', JSON.stringify(history));
    localStorage.setItem('mitarbeiterListe', JSON.stringify(neueZusatz));

    updateBestandTabelle?.();
    updateDashboard?.();
    renderMitarbeiterTabelle?.();
    updateMitarbeiterDatalist?.();
    kategorieWechsel?.();

    alert("‚úÖ Daten erfolgreich geladen");
  } catch (e) {
    console.error(e);
    alert("‚ùå Fehler beim Laden");
  } finally {
    loadInProgress = false;
  }
}






let loginInProgress = false; // global definieren, au√üerhalb der Funktion

// ‚Üì‚Üì‚Üì speichern
async function saveDataToOneDrive() {
  if (loginInProgress) return;
  loginInProgress = true;

  try {
    // ‚úÖ immer so: k√ºmmert sich um silent + loginPopup + activeAccount
    const accessToken = await getAccessToken();
    const { driveId, folderId } = await ensureTargetIds();

    const neueZusatz = mitarbeiterListe.filter(m =>
      !frauenMitarbeiterListe.find(f => f.name === m.name && f.nummer === m.nummer) &&
      !maennerMitarbeiterListe.find(ma => ma.name === m.name && ma.nummer === m.nummer)
    );

    const data = { bestand, history, mitarbeiterListe: neueZusatz };
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });

    const url = `https://graph.microsoft.com/v1.0/drives/${driveId}/items/${folderId}:/bestand.json:/content?@microsoft.graph.conflictBehavior=replace`;

    const r = await fetch(url, {
      method: "PUT",
      headers: { Authorization: `Bearer ${accessToken}` },
      body: blob
    });

    if (!r.ok) throw new Error(await r.text());
    alert("‚úÖ Daten gespeichert!");
  } catch (e) {
    console.error(e);
    alert("‚ùå Fehler beim Speichern");
  } finally {
    loginInProgress = false;
  }
}





// ‚úÖ Nur noch die Liste f√ºr die aktuelle Kategorie neu aufbauen
function updateMitarbeiterDatalist() {
  kategorieWechsel();
}

// ‚úÖ Sortierung + Anzeige (mit f√ºhrender 0 bei M√§nnern) pro Kategorie
function kategorieWechsel() {
  const kategorie = document.getElementById("kategorieSelect").value;
  const mitarbeiterInput = document.getElementById("mitarbeiterInput");
  const mitarbeiterDatalist = document.getElementById("mitarbeiterListe");
  const idInput = document.getElementById("idInput");

  // Felder leeren
  mitarbeiterInput.value = "";
  idInput.value = "";

  if (kategorie === "produktion") {
    // Mitarbeiterfeld deaktivieren
    mitarbeiterInput.disabled = true;
    idInput.disabled = true;
    mitarbeiterDatalist.innerHTML = "";
    return;
  }

  // Mitarbeiterfeld aktivieren
  mitarbeiterInput.disabled = false;
  idInput.disabled = false;

  let quelle = [];
  if (kategorie === "frauen") {
    quelle = [...frauenMitarbeiterListe];
  } else if (kategorie === "maenner") {
    quelle = [...maennerMitarbeiterListe];
  } else if (kategorie === "zeitarbeiter") {
    quelle = [];
  }

  // Zusatzmitarbeiter dieser Kategorie erg√§nzen
  const zusatz = mitarbeiterListe.filter(m =>
    m.kategorie === kategorie &&
    !frauenMitarbeiterListe.includes(m) &&
    !maennerMitarbeiterListe.includes(m)
  );
  quelle = [...quelle, ...zusatz];

  // üî¢ Sortiert nach Spind (numerisch), dann Name
  quelle.sort((a, b) => {
    const na = parseInt(normSpind(a.nummer) || "0", 10);
    const nb = parseInt(normSpind(b.nummer) || "0", 10);
    if (na !== nb) return na - nb;
    return a.name.localeCompare(b.name);
  });

  // üìù Datalist neu aufbauen (Anzeige √ºber displaySpind)
  mitarbeiterDatalist.innerHTML = "";
  quelle.forEach(m => {
    const option = document.createElement("option");
   const sp = displaySpind(m);
option.value = sp ? `${m.name} (${sp})` : m.name;

    mitarbeiterDatalist.appendChild(option);
  });
}




// Initial aufrufen
updateMitarbeiterDatalist();




  </script>

<h2>Speicher zur√ºcksetzen</h2>
<button onclick="clearLocalStorage()">Speicher leeren & neu laden</button>



<script>
function clearLocalStorage() {
  if (confirm("Alle gespeicherten Daten (Bestand, Mitarbeiter usw.) wirklich l√∂schen?")) {
    localStorage.clear();
    location.reload();
  }
}
</script>
<script>
  function toggleMitarbeiterVerwaltung() {
    const container = document.querySelector(".mitarbeiter-container");
    const btn = document.getElementById("toggleMitarbeiterBtn");
    if (container.style.display === "none" || container.style.display === "") {
      container.style.display = "block";
      btn.textContent = "Mitarbeiterverwaltung ausblenden";
    } else {
      container.style.display = "none";
      btn.textContent = "Mitarbeiterverwaltung anzeigen";
    }
  }
</script>


</body>
</html>
